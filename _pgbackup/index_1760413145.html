<!DOCTYPE html>
<html lang="it" class="dark">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Beamlight - Marketing Dashboard</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/customParseFormat.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/quarterOfYear.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
        <style>body { font-family: 'Inter', sans-serif; background-color: #111827; } .card { background-color: #1F2937; border: 1px solid #374151; border-radius: 1rem; } .kpi-card { background-color: #1F2937; border: 1px solid #374151; border-radius: 1rem; } .chart-container { position: relative; height: 350px; width: 100%; } .fade-in { animation: fadeIn 0.8s ease-out forwards; } @keyframes fadeIn { from {  opacity: 0;  transform: translateY(20px); }  to {  opacity: 1;  transform: translateY(0); } } .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #38bdf8; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; } @keyframes rotation { 0% {  transform: rotate(0deg); }  100% {  transform: rotate(360deg); } } #settings-modal { transition: opacity 0.3s ease; } .input-error { border-color: #F87171 !important; box-shadow: 0 0 0 1px #F87171 !important; } .table-scrollbar::-webkit-scrollbar { height: 8px; } .table-scrollbar::-webkit-scrollbar-track { background: #374151; border-radius: 10px; } .table-scrollbar::-webkit-scrollbar-thumb { background: #6b7280; border-radius: 10px; } .table-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; } .quick-btn { background-color: #374151; padding: 0.5rem 0.75rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 500; transition: background-color 0.2s; } .quick-btn:hover { background-color: #4b5563; } .litepicker { background-color: #374151 !important; border-color: #4b5563 !important; } .litepicker .container__months .month-item-header, .litepicker .container__months .month-item { color: #d1d5db; } .litepicker .container__months .month-item:hover { background-color: #4b5563 !important; } .litepicker .container__months .day-item.is-start-date, .litepicker .container__months .day-item.is-end-date { background-color: #0891b2 !important; } .litepicker .container__months .day-item.in-range { background-color: rgba(14, 165, 233, 0.2) !important; } .comparison-value { font-size: 0.8rem; } .positive { color: #34d399; } .negative { color: #f87171; } @media print { body, html {  background-color: #1F2937; }  body * {  visibility: hidden; }  #pdf-export-area, #pdf-export-area * {  visibility: visible; }  #pdf-export-area {  position: absolute;  left: 0;  top: 0;  width: 100%; }  .no-print {  display: none !important; }  .card {  box-shadow: none !important;  border: 1px solid #4b5563; } }</style>
    </head>
    <body class="text-gray-200 p-4 sm:p-6 lg:p-8">
        <div id="settings-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 no-print">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl mx-4">
                <h3 class="text-lg font-medium leading-6 text-white">Configurazione</h3>
                <div class="mt-4 space-y-4">
                    <div>
                        <label for="google-client-id" class="block text-sm font-medium text-gray-300">Google Client ID</label>
                        <input type="text" id="google-client-id" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div>
                        <label for="worker-url" class="block text-sm font-medium text-gray-300">Cloudflare Worker URL</label>
                        <input type="text" id="worker-url" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                </div>
                <hr class="border-gray-700 my-6"/>
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-medium text-white">Configurazione Clienti</h3>
                    <button id="add-client-btn" class="px-3 py-1 text-sm font-medium text-cyan-300 bg-cyan-800/50 hover:bg-cyan-800 rounded-md">+ Aggiungi Cliente</button>
                </div>
                <div class="grid grid-cols-4 gap-2 items-center text-xs text-gray-400 px-2 mt-4"><span>Nome Cliente</span><span>ID Proprietà GA4</span><span>ID Cliente Google Ads</span><span>ID Account Meta Ads</span>
                </div>
                <div id="client-list-container" class="mt-2 space-y-3 max-h-60 overflow-y-auto pr-2"></div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="close-modal-btn" class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-600 hover:bg-gray-500 rounded-md">Annulla</button>
                    <button id="save-settings-btn" class="px-4 py-2 text-sm font-medium text-white bg-cyan-600 hover:bg-cyan-700 rounded-md">Salva Tutto</button>
                </div>
            </div>
        </div>
        <div id="pdf-export-area">
            <div class="container mx-auto max-w-7xl">
                <header class="flex flex-col xl:flex-row justify-between items-start xl:items-center mb-8 fade-in">
                    <div class="flex items-center mb-4 xl:mb-0">
                        <img src="https://beamlight.it/wp-content/uploads/2023/11/BEAMLIGHT-sito-web-nera.png" alt="Beamlight Logo" class="h-10 mr-4">
                        <div>
                            <h1 class="text-3xl font-bold text-white">Marketing Dashboard</h1>
                            <p id="client-name-header" class="text-gray-400 mt-1">Seleziona un cliente per iniziare</p>
                        </div>
                    </div>
                    <!-- CONTROLLI E DATE PICKER GROUP -->
                    <div class="w-full xl:w-auto flex flex-col xl:flex-row items-start xl:items-center space-y-4 xl:space-y-0 xl:space-x-4 no-print">
                        <!-- Colonna Data Picker e Quick Buttons -->
                        <div class="flex flex-col space-y-2 w-full xl:w-auto order-1 xl:order-1">
                            <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-2">
                                <input id="date-picker" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full sm:w-60 p-2.5 cursor-pointer text-center flex-shrink-0">
                                <div class="flex items-center space-x-1 flex-shrink-0">
                                    <button data-quarter="1" class="quick-btn">Q1</button>
                                    <button data-quarter="2" class="quick-btn">Q2</button>
                                    <button data-quarter="3" class="quick-btn">Q3</button>
                                    <button data-quarter="4" class="quick-btn">Q4</button>
                                </div>
                            </div>
                            <!-- RIGA COMPARAZIONE -->
                            <div class="flex items-center space-x-2 w-full justify-start xl:justify-end">
                                <label for="compare-checkbox" class="flex items-center text-sm text-gray-400 cursor-pointer flex-shrink-0">
                                    <input type="checkbox" id="compare-checkbox" class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-cyan-600 focus:ring-cyan-500"><span class="ml-2">Confronta con:</span>
                                </label>
                                <input id="compare-date-picker" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full sm:w-60 p-2.5 cursor-pointer text-center hidden flex-shrink-0">
                            </div>
                        </div>
                        <!-- Colonna Auth, Selector, Utility Buttons -->
                        <div class="flex items-center space-x-4 w-full xl:w-auto order-2 xl:order-2 justify-end">
                            <div class="flex space-x-4 items-center flex-wrap justify-end">
                                <div id="auth-container" class="flex-shrink-0"></div>
                                <select id="client-selector" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full sm:w-auto p-2.5 flex-grow sm:flex-grow-0"></select>
                            </div>
                            <button id="export-pdf-btn" class="p-2 bg-gray-700 rounded-lg hover:bg-gray-600 flex-shrink-0" title="Esporta PDF">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                            </button>
                            <button id="open-modal-btn" class="p-2 bg-gray-700 rounded-lg hover:bg-gray-600 flex-shrink-0" title="Impostazioni">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </header>
                <div id="message-box" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert"></div>
                <div id="loader-overlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 no-print">
                    <div class="loader"></div>
                </div>
                <!-- Nuova griglia KPI con 6 card: 2x3 su mobile, 3x2 su sm, 6x1 su xl -->
                <section id="kpi-section" class="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-6 gap-4 sm:gap-6 mb-8"></section>
                <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card fade-in lg:col-span-2 hidden" id="ga4-chart-card">
                        <div class="p-6">
                            <h2 class="text-xl font-semibold text-white">Traffico GA4: Utenti Attivi vs Sessioni</h2>
                        </div>
                        <div class="px-6 pb-6">
                            <div class="chart-container">
                                <canvas id="ga4Chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card fade-in hidden" id="gads-card-container">
                        <div class="p-6">
                            <h2 class="text-xl font-semibold text-white">Performance Campagne Google Ads</h2>
                        </div>
                        <div class="px-2 pb-6">
                            <div id="gads-table-container" class="overflow-x-auto table-scrollbar"></div>
                        </div>
                    </div>
                    <div class="card fade-in hidden" id="meta-card-container">
                        <div class="p-6">
                            <h2 class="text-xl font-semibold text-white">Performance Campagne Meta Ads</h2>
                        </div>
                        <div class="px-2 pb-6">
                            <div id="meta-table-container" class="overflow-x-auto table-scrollbar"></div>
                        </div>
                    </div>
                    <div class="card fade-in hidden" id="ga4-traffic-card">
                        <div class="p-6">
                            <h2 class="text-xl font-semibold text-white">GA4: Sorgenti di Traffico</h2>
                        </div>
                        <div class="px-2 pb-6">
                            <div id="traffic-table-container" class="overflow-x-auto table-scrollbar"></div>
                        </div>
                    </div>
                    <div class="card fade-in hidden" id="ga4-geo-card">
                        <div class="p-6">
                            <h2 class="text-xl font-semibold text-white">GA4: Utenti per Paese</h2>
                        </div>
                        <div class="px-2 pb-6">
                            <div id="geo-table-container" class="overflow-x-auto table-scrollbar"></div>
                        </div>
                    </div>
                    <div class="card fade-in lg:col-span-2">
                        <div class="p-6">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-semibold text-white">Considerazioni Finali e Analisi</h2>
                                <button id="generate-insights-btn" class="flex items-center px-3 py-2 text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 rounded-md no-print">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12.846 3.636a.5.5 0 0 0-.692 0l-3 4.5A.5.5 0 0 0 9.5 9h5a.5.5 0 0 0 .346-.864l-3-4.5ZM13 10.5V14h.5a.5.5 0 0 1 0 1H11v-4.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5Zm-2 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2Z"/>
                                    </svg><span id="gemini-btn-text">Genera con Gemini</span>
                                    <div id="gemini-loader" class="hidden ml-2 w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                </button>
                            </div>
                            <textarea id="insights-textarea" class="mt-4 w-full h-48 bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:outline-none focus:ring-cyan-500 focus:border-cyan-500" placeholder="Scrivi qui le tue analisi o clicca 'Genera con Gemini' per un'analisi automatica..."></textarea>
                        </div>
                    </div>
                </main>
            </div>
        </div>
        <script type="module">
// --- SETUP ---
// I plugin Day.js devono essere registrati DOPO che la libreria principale è caricata.
// Spostiamo qui l'estensione, dove siamo sicuri che dayjs sia definito.
dayjs.extend(dayjs_plugin_customParseFormat);
dayjs.extend(dayjs_plugin_quarterOfYear);

const clientSelector = document.getElementById('client-selector');
const loader = document.getElementById('loader-overlay');
const modal = document.getElementById('settings-modal');
const clientIdInput = document.getElementById('google-client-id');
const workerUrlInput = document.getElementById('worker-url');
const clientListContainer = document.getElementById('client-list-container');
let charts = {};
let googleAuthToken = null;
let appConfig = {};
let dateRange = { start: dayjs().subtract(7, 'day'), end: dayjs() };
let compareDateRange = { start: null, end: null };
let isCompareMode = false;
let datePicker, compareDatePicker;
let currentData = {};

// --- FUNZIONI HELPER ---
function showMessage(text, type = 'warning') {
    const box = document.getElementById('message-box');
    const colors = {
        warning: 'text-yellow-300 bg-yellow-900/50',
        error: 'text-red-300 bg-red-900/50',
        success: 'text-green-300 bg-green-900/50',
    };
    box.textContent = text;
    box.className = `p-4 mb-4 text-sm rounded-lg ${colors[type]}`;
    box.classList.remove('hidden');
}

function formatCurrency(value) {
    return `€${(value || 0).toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
}

function formatNumber(value) {
    return (value || 0).toLocaleString('it-IT');
}

function formatPercentage(value, decimals = 2) {
    return `${(value * 100).toFixed(decimals)}%`.replace('.', ',');
}

function formatTime(seconds) {
    if (seconds === undefined || seconds === null) return 'N/A';
    const minutes = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${minutes}m ${secs}s`;
}


function formatComparison(current, previous, key) {
    if (previous === null || previous === undefined || !isFinite(current) || !isFinite(previous)) return '';
    const diff = current - previous;
    const percentage = previous !== 0 ? (diff / previous) : (current > 0 ? Infinity : 0);
    
    const isPositive = diff >= 0;
    const isGood = ['conversions', 'clicks', 'ctr', 'engagementRate', 'searchImpressionShare', 'activeUsers', 'averageSessionDuration'].includes(key);
    const isBad = ['cost', 'cpa', 'cpc', 'gadsCost', 'metaSpend'];

    let colorClass = 'text-gray-400';
    // Logic: if key is 'good', positive change is good. If key is 'bad' (cost metrics), negative change is good.
    if (isGood && isPositive) {
        colorClass = 'positive';
    } else if (isBad.includes(key) && !isPositive) {
        colorClass = 'positive';
    } else if ((isBad.includes(key) && isPositive) || (isGood && !isPositive)) {
        colorClass = 'negative';
    }


    const sign = diff >= 0 ? '+' : '';
    const percentageSign = percentage !== Infinity ? `(${sign}${(percentage * 100).toFixed(1)}%)` : '(Nuovo)';

    return `<span class="comparison-value ${colorClass} ml-2">${percentageSign}</span>`;
}

// --- GESTIONE CONFIGURAZIONE ---
function loadInitialConfig() {
    try {
        const localConfig = localStorage.getItem('beamlightDashboardBootstrap');
        const parsed = localConfig ? JSON.parse(localConfig) : {};
        appConfig.googleClientId = parsed.googleClientId || "";
        appConfig.workerUrl = parsed.workerUrl || "";
    } catch (e) {
        appConfig.googleClientId = "";
        appConfig.workerUrl = "";
    }
    appConfig.clients = { 'cliente_default': { name: 'Nessun cliente', ga4PropertyId: '' } };
}

async function loadRemoteConfig() {
    if (!googleAuthToken || !appConfig.workerUrl) return;
    loader.classList.remove('hidden');
    try {
        const response = await fetch(`${appConfig.workerUrl}/config`, { headers: { 'Authorization': `Bearer ${googleAuthToken}` } });
        if (!response.ok) throw new Error('Failed to fetch remote config');
        const remoteConfig = await response.json();
        appConfig = { ...appConfig, ...remoteConfig };
        if (!appConfig.clients || Object.keys(appConfig.clients).length === 0) {
            appConfig.clients = { 'cliente1': { name: 'Cliente A (Esempio)', ga4PropertyId: '' } };
        }
        populateClientSelector();
        updateDashboard();
    } catch (e) {
        showMessage("Impossibile caricare la configurazione dei clienti.", "error");
    } finally {
        loader.classList.add('hidden');
    }
}

async function saveConfig() {
    const configToSave = {
        googleClientId: clientIdInput.value.trim(),
        workerUrl: workerUrlInput.value.trim(),
        clients: {}
    };
    let hasError = false;
    if (!configToSave.googleClientId) { showMessage('Il campo Google Client ID non può essere vuoto.', 'error'); clientIdInput.classList.add('input-error'); hasError = true; }
    if (!configToSave.workerUrl) { showMessage('Il campo Cloudflare Worker URL non può essere vuoto.', 'error'); workerUrlInput.classList.add('input-error'); hasError = true; }
    if (hasError) return;
    clientIdInput.classList.remove('input-error');
    workerUrlInput.classList.remove('input-error');
    localStorage.setItem('beamlightDashboardBootstrap', JSON.stringify({ googleClientId: configToSave.googleClientId, workerUrl: configToSave.workerUrl }));
    appConfig.googleClientId = configToSave.googleClientId;
    appConfig.workerUrl = configToSave.workerUrl;
    if (!googleAuthToken) {
        showMessage("Configurazione di base salvata. Ora puoi collegare il tuo account Google.", "warning");
        modal.classList.add('hidden');
        return;
    }
    clientListContainer.querySelectorAll('.client-row').forEach(row => {
        const id = row.dataset.clientId;
        const name = row.querySelector('.client-name-input').value.trim();
        const ga4Id = row.querySelector('.client-ga4-input').value.trim();
        const gAdsId = row.querySelector('.client-gads-input').value.trim();
        const metaId = row.querySelector('.client-meta-input').value.trim();
        if (name) configToSave.clients[id] = { name, ga4PropertyId: ga4Id, gAdsCustomerId: gAdsId, metaAdAccountId: metaId };
    });
    try {
        loader.classList.remove('hidden');
        const response = await fetch(`${configToSave.workerUrl}/config`, { method: 'POST', headers: { 'Authorization': `Bearer ${googleAuthToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify(configToSave) });
        if (!response.ok) throw new Error('Salvataggio su DB fallito');
        appConfig = configToSave;
        modal.classList.add('hidden');
        showMessage('Configurazione salvata con successo.', 'success');
        populateClientSelector();
        updateDashboard();
    } catch (e) {
        showMessage(`Errore nel salvataggio remoto: ${e.message}`, "error");
    } finally {
        loader.classList.add('hidden');
    }
}

function populateClientSelector() {
    const currentVal = clientSelector.value;
    clientSelector.innerHTML = '';
    if (appConfig && appConfig.clients) {
        Object.entries(appConfig.clients).forEach(([id, { name }]) => clientSelector.add(new Option(name, id)));
    }
    if (currentVal) clientSelector.value = currentVal;
    document.getElementById('client-name-header').textContent = appConfig.clients[clientSelector.value]?.name || 'Seleziona un cliente';
}

function populateClientSettingsList() {
    clientListContainer.innerHTML = '';
    if (!appConfig || !appConfig.clients) return;
    Object.entries(appConfig.clients).forEach(([id, { name, ga4PropertyId, gAdsCustomerId, metaAdAccountId }]) => {
        const clientRow = document.createElement('div');
        clientRow.className = 'client-row grid grid-cols-4 gap-2 items-center';
        clientRow.dataset.clientId = id;
        clientRow.innerHTML = `
            <input type="text" value="${name}" class="client-name-input bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white" placeholder="Nome Cliente">
            <input type="text" value="${ga4PropertyId || ''}" class="client-ga4-input bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white" placeholder="ID Proprietà GA4">
            <input type="text" value="${gAdsCustomerId || ''}" class="client-gads-input bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white" placeholder="ID Cliente Google Ads">
            <input type="text" value="${metaAdAccountId || ''}" class="client-meta-input bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white" placeholder="ID Account Meta Ads">`;
    clientListContainer.appendChild(clientRow);
    });
}

function addNewClient() {
    const clientId = `cliente_${Date.now()}`;
    const clientRow = document.createElement('div');
    clientRow.className = 'client-row grid grid-cols-4 gap-2 items-center';
    clientRow.dataset.clientId = clientId;
    clientRow.innerHTML = `
        <input type="text" value="" class="client-name-input bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white" placeholder="Nuovo Cliente">
        <input type="text" value="" class="client-ga4-input bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white" placeholder="ID Proprietà GA4">
        <input type="text" value="" class="client-gads-input bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white" placeholder="ID Cliente Google Ads">
        <input type="text" value="" class="client-meta-input bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white" placeholder="ID Account Meta Ads">`;
    clientListContainer.appendChild(clientRow);
    clientRow.querySelector('.client-name-input').focus();
}

// --- LOGICA DI AUTENTICAZIONE ---
function handleGoogleAuth() {
    let workerUrl = appConfig.workerUrl;
    let clientId = appConfig.googleClientId;
    if (!clientId || !workerUrl) { showMessage('Compila Client ID e Worker URL nelle impostazioni (⚙️).', 'error'); modal.classList.remove('hidden'); return; }
    const scopes = 'openid https://www.googleapis.com/auth/analytics.readonly https://www.googleapis.com/auth/adwords';
    const redirectUri = `${workerUrl}/google-auth-callback`;
    const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=code&scope=${scopes}&access_type=offline&prompt=consent`;
    window.location.href = authUrl;
}

function updateUIonAuthSuccess() {
    document.getElementById('auth-container').innerHTML = `<div class="flex items-center p-2 rounded-md bg-green-900/70 text-green-300 text-sm"><svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>Connesso</div>`;
}

function updateUIonAuthFailure() {
    document.getElementById('auth-container').innerHTML = `<button id="google-auth-button" class="px-4 py-2 text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">Collega Google</button>`;
    document.getElementById('google-auth-button')?.addEventListener('click', handleGoogleAuth);
}

// --- LOGICA DI AGGIORNAMENTO DATI ---
async function updateDashboard() {
    loader.classList.remove('hidden');
    if (!appConfig.clients) { renderMockData(); loader.classList.add('hidden'); return; }
    const selectedClientId = clientSelector.value;
    const clientData = appConfig.clients[selectedClientId];
    document.getElementById('client-name-header').textContent = clientData?.name || 'Seleziona un cliente';
    if (!clientData) { showMessage("Cliente non trovato.", "error"); renderMockData(); loader.classList.add('hidden'); return; }
    toggleUIVisibility(clientData);
    if (!googleAuthToken) { renderMockData(); loader.classList.add('hidden'); return; }
    if (!clientData.ga4PropertyId && !clientData.gAdsCustomerId && !clientData.metaAdAccountId) {
        showMessage(`Nessun ID configurato per "${clientData.name}".`, 'warning');
        renderMockData();
        loader.classList.add('hidden');
        return;
    }
    try {
        document.getElementById('message-box').classList.add('hidden');
        const fetchDataForRange = async (range) => {
            if (!range || !range.start) return null;
            const dateParams = `&startDate=${range.start.format('YYYY-MM-DD')}&endDate=${range.end.format('YYYY-MM-DD')}`;
            const promises = [];
            if (clientData.ga4PropertyId) promises.push(fetch(`${appConfig.workerUrl}/ga4?propertyId=${clientData.ga4PropertyId}${dateParams}`, { headers: { 'Authorization': `Bearer ${googleAuthToken}` } })); else promises.push(Promise.resolve(null));
            if (clientData.gAdsCustomerId) promises.push(fetch(`${appConfig.workerUrl}/google-ads?customerId=${clientData.gAdsCustomerId}${dateParams}`, { headers: { 'Authorization': `Bearer ${googleAuthToken}` } })); else promises.push(Promise.resolve(null));
            if (clientData.metaAdAccountId) promises.push(fetch(`${appConfig.workerUrl}/meta-ads?adAccountId=${clientData.metaAdAccountId}${dateParams}`)); else promises.push(Promise.resolve(null));
            const [ga4Res, gAdsRes, metaRes] = await Promise.all(promises);
            const ga4Data = ga4Res ? (ga4Res.ok ? await ga4Res.json() : Promise.reject(new Error((await ga4Res.json()).error || 'Errore GA4'))) : {};
            const gAdsData = gAdsRes ? (gAdsRes.ok ? await gAdsRes.json() : Promise.reject(new Error((await gAdsRes.json()).error || 'Errore Google Ads'))) : {};
            const metaData = metaRes ? (metaRes.ok ? await metaRes.json() : Promise.reject(new Error((await metaRes.json()).error || 'Errore Meta Ads'))) : {};
            return {
                ga4: processGA4Data(ga4Data), gads: processGAdsData(gAdsData), meta: processMetaData(metaData),
                gadsSandbox: gAdsData.sandbox, gadsSandboxReason: gAdsData.sandbox_reason,
                metaSandbox: metaData.sandbox, metaSandboxReason: metaData.sandbox_reason,
            };
        };
        const primaryData = await fetchDataForRange(dateRange);
        const comparisonData = isCompareMode ? await fetchDataForRange(compareDateRange) : null;
        currentData = { primary: primaryData, comparison: comparisonData };
        renderKPIs(primaryData, comparisonData);
        renderTrafficTable(primaryData.ga4.traffic);
        renderGeoTable(primaryData.ga4.geo);
        renderGAdsTable(primaryData.gads.campaigns, primaryData.gadsSandbox);
        renderMetaTable(primaryData.meta.campaigns, primaryData.metaSandbox);
        renderCharts(primaryData.ga4.timeseries);
        if (primaryData.gadsSandbox || primaryData.metaSandbox) {
            const gAdsMessage = primaryData.gadsSandbox ? `Google Ads (Motivo: ${primaryData.gadsSandboxReason})` : null;
            const metaMessage = primaryData.metaSandbox ? `Meta Ads (Motivo: ${primaryData.metaSandboxReason})` : null;
            const sandboxPlatforms = [gAdsMessage, metaMessage].filter(Boolean).join(' e ');
            showMessage(`ATTENZIONE: I dati di ${sandboxPlatforms} sono simulati (modalità Sandbox).`, "warning");
        }
    } catch (error) {
        showMessage(`Errore durante il caricamento dei dati: ${error.message}.`, 'error');
        renderMockData();
    } finally {
        loader.classList.add('hidden');
    }
}

function renderMockData() {
    // Dati di Mock più coerenti per simulare il successo di un cliente
    const mockCampaigns = [
        { campaign: { name: "Campagna Brand (Demo)" }, metrics: { clicks: 500, impressions: 30000, costMicros: 1500000, conversions: 40, costPerConversion: 37500, searchImpressionShare: 0.90 } },
        { campaign: { name: "Performance Max (Demo)" }, metrics: { clicks: 750, impressions: 45000, costMicros: 3500000, conversions: 55, costPerConversion: 63636, searchImpressionShare: 0.70 } },
    ];
    
    // Correzione: Spesa Meta ridotta e CPA realistico.
    const mockMeta = {
        data: [
            { campaign_name: "Lead Generation (Demo)", spend: 450.00, impressions: 80000, clicks: 1200, ctr: 1.5, cpc: 0.37, conversions: 30, cost_per_action_type: [{action_type: 'lead', value: '15.00'}] },
        ],
        sandbox: true,
        sandbox_reason: "Mock Dati Google Ads e Meta Ads attivi (GA4 è sempre mock se non autenticato)",
    };

    const mockGA4 = {
        // activeUsers(0), newUsers(1), averageSessionDuration(2), eventCount(3), conversions(4)
        totals: { rows: [{ metricValues: [{ value: 892 }, { value: 887 }, { value: 65 }, { value: 4162 }, { value: 125 }] }] }, 
        timeseries: { 
            rows: [
                { dimensionValues: [{ value: '20251008' }], metricValues: [{ value: 100 }, { value: 50 }] },
                { dimensionValues: [{ value: '20251009' }], metricValues: [{ value: 120 }, { value: 60 }] },
                { dimensionValues: [{ value: '20251010' }], metricValues: [{ value: 180 }, { value: 90 }] },
                { dimensionValues: [{ value: '20251011' }], metricValues: [{ value: 150 }, { value: 80 }] },
                { dimensionValues: [{ value: '20251012' }], metricValues: [{ value: 110 }, { value: 55 }] },
                { dimensionValues: [{ value: '20251013' }], metricValues: [{ value: 90 }, { value: 45 }] },
                { dimensionValues: [{ value: '20251014' }], metricValues: [{ value: 142 }, { value: 70 }] },
            ].reverse() 
        }, 
        traffic: { rows: [
            { dimensionValues: [{ value: 'google / cpc' }], metricValues: [{ value: 300 }, { value: 200 }, { value: 95 }] },
            { dimensionValues: [{ value: 'facebook / cpc' }], metricValues: [{ value: 250 }, { value: 180 }, { value: 30 }] },
            { dimensionValues: [{ value: 'google / organic' }], metricValues: [{ value: 80 }, { value: 40 }, { value: 5 }] },
            { dimensionValues: [{ value: 'direct / (none)' }], metricValues: [{ value: 60 }, { value: 30 }, { value: 0 }] }
        ]},
        geo: { rows: [{ dimensionValues: [{ value: 'Italy' }], metricValues: [{ value: 400 }] }] }
    };


    const primaryData = {
        ga4: processGA4Data(mockGA4),
        gads: processGAdsData({ campaigns: mockCampaigns }),
        meta: processMetaData(mockMeta),
        gadsSandbox: true,
        metaSandbox: true,
    };
    
    currentData = { primary: primaryData, comparison: null };

    toggleUIVisibility(appConfig.clients[clientSelector.value]);
    renderKPIs(primaryData, null);
    renderTrafficTable(primaryData.ga4.traffic);
    renderGeoTable(primaryData.ga4.geo);
    renderGAdsTable(primaryData.gads.campaigns, primaryData.gadsSandbox);
    renderMetaTable(primaryData.meta.campaigns, primaryData.metaSandbox);
    renderCharts(primaryData.ga4.timeseries);
    
    showMessage("ATTENZIONE: Stai visualizzando i dati di Mock per Google Ads e Meta Ads. Collega i tuoi account per i dati reali.", "warning");
}

// --- FUNZIONI DI ELABORAZIONE ---
function processGA4Data(data) {
    const safeParse = (val) => parseInt(val || '0', 10);
    const safeParseFloat = (val) => parseFloat(val || '0');
    
    // Indici basati sul Worker: activeUsers(0), newUsers(1), averageSessionDuration(2), eventCount(3), conversions(4)
    // Se data.totals.rows è definito, prendiamo il primo elemento
    const metrics = data.totals?.rows?.[0]?.metricValues;

    const totals = {
        activeUsers: safeParse(metrics?.[0]?.value),
        newUsers: safeParse(metrics?.[1]?.value),
        averageSessionDuration: safeParseFloat(metrics?.[2]?.value),
        eventCount: safeParse(metrics?.[3]?.value),
        conversions: safeParse(metrics?.[4]?.value),
    };
    // Ricalcolo del tasso di coinvolgimento basato sulle metriche disponibili per coerenza
    // Nota: GA4 usa engagedSessions/sessions, ma useremo activeUsers per la card principale.
    totals.engagementRate = totals.activeUsers > 0 ? (totals.conversions / totals.activeUsers) : 0; 
    
    // Timeseries: activeUsers(0), sessions(1)
    const timeseries = {
        labels: data.timeseries?.rows?.slice().reverse().map(r => dayjs(r.dimensionValues[0].value, 'YYYYMMDD').format('DD/MM')) || [],
        activeUsers: data.timeseries?.rows?.slice().reverse().map(r => safeParse(r.metricValues[0].value)) || [],
        sessions: data.timeseries?.rows?.slice().reverse().map(r => safeParse(r.metricValues[1].value)) || [],
    };
    
    // Traffic: sessionSourceMedium(0), activeUsers(1), sessions(2), conversions(3)
    const traffic = data.traffic?.rows?.map(r => ({
        source: r.dimensionValues[0].value,
        users: safeParse(r.metricValues[0].value),
        sessions: safeParse(r.metricValues[1].value),
        conversions: safeParse(r.metricValues[2].value),
    })) || [];
    
    // Geo: country(0), activeUsers(1)
    const geo = data.geo?.rows?.map(r => ({
        country: r.dimensionValues[0].value,
        users: safeParse(r.metricValues[0].value),
    })) || [];
    return { totals, timeseries, traffic, geo };
}

function processGAdsData(data) {
    // Calcola i totali aggregando i dati di tutte le campagne (data.campaigns)
    // Il Worker non invia più 'totals' da 'FROM customer', quindi dobbiamo calcolare tutto qui.
    const campaignsRaw = data.campaigns || [];
    const totalCostMicros = campaignsRaw.reduce((sum, c) => sum + (c.metrics?.costMicros || 0), 0);
    const totalClicks = campaignsRaw.reduce((sum, c) => sum + parseInt(c.metrics?.clicks || 0), 0);
    const totalImpressions = campaignsRaw.reduce((sum, c) => sum + parseInt(c.metrics?.impressions || 0), 0);
    const totalConversions = campaignsRaw.reduce((sum, c) => sum + parseFloat(c.metrics?.conversions || 0), 0);
    
    const totalCost = totalCostMicros / 1000000;

    const totals = {
        cost: totalCost, // In Valuta (€)
        clicks: totalClicks,
        impressions: totalImpressions,
        ctr: totalImpressions > 0 ? totalClicks / totalImpressions : 0,
        cpc: totalClicks > 0 ? totalCost / totalClicks : 0,
        conversions: totalConversions,
        cpa: totalConversions > 0 ? totalCost / totalConversions : 0,
    };
    
    // Processa i dati delle singole campagne
    const campaigns = campaignsRaw.map(c => ({
        name: c.campaign.name,
        clicks: parseInt(c.metrics.clicks || 0),
        impressions: parseInt(c.metrics.impressions || 0),
        cost: (c.metrics.costMicros || 0) / 1000000, // In Valuta (€)
        conversions: parseFloat(c.metrics.conversions || 0),
        // CPA per riga in Valuta (€)
        cpa: (c.metrics.costPerConversion || 0) / 1000000, 
        searchImpressionShare: parseFloat(c.metrics.searchImpressionShare || 0),
    }));
    
    return { totals, campaigns };
}

function processMetaData(data) {
    const PRIMARY_CONVERSION_ACTIONS = ['purchase', 'lead', 'complete_registration', 'onsite_conversion.post_save'];
    const campaigns = (data.data || []).map(c => {
        let conversions = 0;
        let cpa = 0;
        if (c.actions) {
            for (const action of c.actions) {
                // Aggregate specific conversion types
                if (PRIMARY_CONVERSION_ACTIONS.includes(action.action_type) || action.action_type.includes('purchase') || action.action_type.includes('lead')) {
                    conversions += parseInt(action.value, 10);
                }
            }
        }
        if (c.cost_per_action_type) {
           // Find first relevant CPA
           for (const cost_action of c.cost_per_action_type) {
                if (PRIMARY_CONVERSION_ACTIONS.includes(cost_action.action_type) || cost_action.action_type.includes('purchase') || cost_action.action_type.includes('lead')) {
                    cpa = parseFloat(cost_action.value);
                    break;
                }
            }
        }
        return {
            name: c.campaign_name, spend: parseFloat(c.spend || 0), impressions: parseInt(c.impressions || 0),
            clicks: parseInt(c.clicks || 0), ctr: parseFloat(c.ctr || 0), cpc: parseFloat(c.cpc || 0),
            conversions, cpa
        };
    });
    const totals = {
        spend: campaigns.reduce((s, c) => s + c.spend, 0), // In Valuta (€)
        impressions: campaigns.reduce((s, c) => s + c.impressions, 0),
        clicks: campaigns.reduce((s, c) => s + c.clicks, 0),
        conversions: campaigns.reduce((s, c) => s + c.conversions, 0),
    };
    return { totals, campaigns };
}

// --- FUNZIONI DI VISUALIZZAZIONE ---
function toggleUIVisibility(clientData = {}) {
    document.getElementById('ga4-chart-card').classList.toggle('hidden', !clientData.ga4PropertyId);
    document.getElementById('ga4-traffic-card').classList.toggle('hidden', !clientData.ga4PropertyId);
    document.getElementById('ga4-geo-card').classList.toggle('hidden', !clientData.ga4PropertyId);
    document.getElementById('gads-card-container').classList.toggle('hidden', !clientData.gAdsCustomerId);
    document.getElementById('meta-card-container').classList.toggle('hidden', !clientData.metaAdAccountId);
}

function renderKPIs(primary, comparison) {
    // Calculate Aggregated Primary KPIs
    const gadsCost = primary.gads?.totals?.cost || 0;
    const metaSpend = primary.meta?.totals?.spend || 0;

    const p = {
        cost: gadsCost + metaSpend,
        gadsCost: gadsCost,
        metaSpend: metaSpend,
        clicks: (primary.gads?.totals?.clicks || 0) + (primary.meta?.totals?.clicks || 0),
        impressions: (primary.gads?.totals?.impressions || 0) + (primary.meta?.totals?.impressions || 0),
        // Aggregate conversions from GA4 (general) + Ads platforms (specific conversion data)
        conversions: (primary.ga4?.totals?.conversions || 0) + (primary.gads?.totals?.conversions || 0) + (primary.meta?.totals?.conversions || 0),
        
        // Nuove metriche GA4
        activeUsers: primary.ga4?.totals?.activeUsers || 0,
        newUsers: primary.ga4?.totals?.newUsers || 0,
        averageSessionDuration: primary.ga4?.totals?.averageSessionDuration || 0,
        eventCount: primary.ga4?.totals?.eventCount || 0,
    };
    p.cpa = p.conversions > 0 ? p.cost / p.conversions : 0;
    
    // Calculate Aggregated Comparison KPIs
    let c = null;
    if (comparison) {
        const cGadsCost = comparison.gads?.totals?.cost || 0;
        const cMetaSpend = comparison.meta?.totals?.spend || 0;

        c = {
            cost: cGadsCost + cMetaSpend,
            gadsCost: cGadsCost,
            metaSpend: cMetaSpend,
            clicks: (comparison.gads?.totals?.clicks || 0) + (comparison.meta?.totals?.clicks || 0),
            impressions: (comparison.gads?.totals?.impressions || 0) + (comparison.meta?.totals?.impressions || 0),
            conversions: (comparison.ga4?.totals?.conversions || 0) + (comparison.gads?.totals?.conversions || 0) + (comparison.meta?.totals?.conversions || 0),
            activeUsers: comparison.ga4?.totals?.activeUsers || 0,
            averageSessionDuration: comparison.ga4?.totals?.averageSessionDuration || 0,
        };
        c.cpa = c.conversions > 0 ? c.cost / c.conversions : 0;
    }
    
    const kpiSection = document.getElementById('kpi-section');
    kpiSection.innerHTML = `
        <div class="kpi-card p-4 fade-in"><p class="text-sm text-gray-400">Spesa Totale</p><p class="text-2xl font-bold text-white">${formatCurrency(p.cost)} ${c ? formatComparison(p.cost, c.cost, 'cost') : ''}</p></div>
        <div class="kpi-card p-4 fade-in"><p class="text-sm text-gray-400">Costo Google Ads</p><p class="text-2xl font-bold text-white">${formatCurrency(p.gadsCost)} ${c ? formatComparison(p.gadsCost, c.gadsCost, 'gadsCost') : ''}</p></div>
        <div class="kpi-card p-4 fade-in"><p class="text-sm text-gray-400">Spesa Meta Ads</p><p class="text-2xl font-bold text-white">${formatCurrency(p.metaSpend)} ${c ? formatComparison(p.metaSpend, c.metaSpend, 'metaSpend') : ''}</p></div>
        <div class="kpi-card p-4 fade-in"><p class="text-sm text-gray-400">CPA Globale</p><p class="text-2xl font-bold text-white">${formatCurrency(p.cpa)} ${c ? formatComparison(p.cpa, c.cpa, 'cpa') : ''}</p></div>
        <div class="kpi-card p-4 fade-in"><p class="text-sm text-gray-400">Utenti Attivi</p><p class="text-2xl font-bold text-white">${formatNumber(p.activeUsers)} ${c ? formatComparison(p.activeUsers, c.activeUsers, 'activeUsers') : ''}</p></div>
        <div class="kpi-card p-4 fade-in"><p class="text-sm text-gray-400">Conversioni Totali</p><p class="text-2xl font-bold text-white">${formatNumber(p.conversions)} ${c ? formatComparison(p.conversions, c.conversions, 'conversions') : ''}</p></div>
    `;
}

function createTable(containerId, headers, data) {
    const container = document.getElementById(containerId);
    if (!data || data.length === 0) {
        container.innerHTML = `<p class="text-center text-gray-500 py-8">Nessun dato disponibile.</p>`;
        return;
    }
    const table = document.createElement('table');
    table.className = "w-full text-sm text-left text-gray-400";
    table.innerHTML = `
        <thead class="text-xs text-gray-300 uppercase bg-gray-700">
            <tr>${headers.map(h => `<th scope="col" class="px-6 py-3">${h}</th>`).join('')}</tr>
        </thead>
        <tbody>
            ${data.map(row => `
                <tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-600">
                    ${row.map((cell, i) => i === 0 ? `<td class="px-6 py-4 font-medium text-white whitespace-nowrap">${cell}</td>` : `<td class="px-6 py-4">${cell}</td>`).join('')}
                </tr>
            `).join('')}
        </tbody>
    `;
    container.innerHTML = '';
    container.appendChild(table);
}

function renderTrafficTable(data) {
    const headers = ["Fonte / Mezzo", "Utenti", "Sessioni", "Conversioni"];
    const rows = data.map(d => [d.source, formatNumber(d.users), formatNumber(d.sessions), formatNumber(d.conversions)]);
    createTable('traffic-table-container', headers, rows);
}

function renderGeoTable(data) {
    const headers = ["Paese", "Utenti"];
    const rows = data.map(d => [d.country, formatNumber(d.users)]);
    createTable('geo-table-container', headers, rows);
}

function renderGAdsTable(data, sandbox) {
    const title = document.querySelector('#gads-card-container h2');
    title.innerHTML = `Performance Campagne Google Ads ${sandbox ? '<span class="text-xs text-yellow-400 font-medium ml-2 py-0.5 px-1.5 rounded-md bg-yellow-900/50">SANDBOX</span>' : ''}`;
    const headers = ["Campagna", "Costo", "Click", "Impressioni", "Conversioni", "CPA", "Q. Imp."];
    const rows = data.map(d => [d.name, formatCurrency(d.cost), formatNumber(d.clicks), formatNumber(d.impressions), formatNumber(d.conversions), formatCurrency(d.cpa), formatPercentage(d.searchImpressionShare)]);
    createTable('gads-table-container', headers, rows);
}

function renderMetaTable(data, sandbox) {
    const title = document.querySelector('#meta-card-container h2');
    title.innerHTML = `Performance Campagne Meta Ads ${sandbox ? '<span class="text-xs text-yellow-400 font-medium ml-2 py-0.5 px-1.5 rounded-md bg-yellow-900/50">SANDBOX</span>' : ''}`;
    const headers = ["Campagna", "Spesa", "Impressioni", "Click", "Conversioni", "CPA"];
    const rows = data.map(d => [d.name, formatCurrency(d.spend), formatNumber(d.impressions), formatNumber(d.clicks), formatNumber(d.conversions), formatCurrency(d.cpa)]);
    createTable('meta-table-container', headers, rows);
}

function renderCharts(ga4Timeseries) {
    const ga4Ctx = document.getElementById('ga4Chart').getContext('2d');
    if (charts.ga4) charts.ga4.destroy();
    charts.ga4 = new Chart(ga4Ctx, {
        type: 'line',
        data: {
            labels: ga4Timeseries.labels,
            datasets: [
                { label: 'Utenti Attivi', data: ga4Timeseries.activeUsers, borderColor: 'rgb(34, 211, 238)', backgroundColor: 'rgba(34, 211, 238, 0.2)', tension: 0.4, fill: true, yAxisID: 'y' },
                { label: 'Sessioni', data: ga4Timeseries.sessions, borderColor: 'rgb(16, 185, 129)', backgroundColor: 'rgba(16, 185, 129, 0.2)', tension: 0.4, fill: true, yAxisID: 'y' }
            ]
        },
        options: { animation: false, responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#9CA3AF' } }, x: { grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#9CA3AF' } } }, plugins: { legend: { position: 'top', labels: { color: '#D1D5DB' } } } }
    });
}

// --- INIZIALIZZAZIONE ---
async function initialize() {
    loadInitialConfig(); 
    
    datePicker = new Litepicker({
        element: document.getElementById('date-picker'),
        singleMode: false,
        format: 'DD/MM/YYYY',
        startDate: dateRange.start.toDate(),
        endDate: dateRange.end.toDate(),
        setup: (picker) => {
            picker.on('selected', (date1, date2) => {
                dateRange.start = dayjs(date1.dateInstance);
                dateRange.end = dayjs(date2.dateInstance);
                if (isCompareMode) {
                    const diff = dateRange.end.diff(dateRange.start, 'day');
                    compareDateRange.start = dateRange.start.subtract(diff + 1, 'day');
                    compareDateRange.end = dateRange.start.subtract(1, 'day');
                    compareDatePicker.setDateRange(compareDateRange.start.toDate(), compareDateRange.end.toDate());
                }
                updateDashboard();
            });
        },
    });

    compareDatePicker = new Litepicker({
        element: document.getElementById('compare-date-picker'),
        singleMode: false,
        format: 'DD/MM/YYYY',
        setup: (picker) => {
            picker.on('selected', (date1, date2) => {
                compareDateRange.start = dayjs(date1.dateInstance);
                compareDateRange.end = dayjs(date2.dateInstance);
                updateDashboard();
            });
        },
    });

    document.querySelectorAll('.quick-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const quarter = parseInt(btn.dataset.quarter);
            const year = dayjs().year();
            const startDate = dayjs().year(year).quarter(quarter).startOf('quarter');
            const endDate = dayjs().year(year).quarter(quarter).endOf('quarter');
            datePicker.setDateRange(startDate.toDate(), endDate.toDate());
        });
    });

    document.getElementById('compare-checkbox').addEventListener('change', (e) => {
        isCompareMode = e.target.checked;
        document.getElementById('compare-date-picker').classList.toggle('hidden', !isCompareMode);
        if (isCompareMode) {
            const diff = dateRange.end.diff(dateRange.start, 'day');
            compareDateRange.start = dateRange.start.subtract(diff + 1, 'day');
            compareDateRange.end = dateRange.start.subtract(1, 'day');
            compareDatePicker.setDateRange(compareDateRange.start.toDate(), compareDateRange.end.toDate());
        } else {
            compareDateRange.start = null;
            compareDateRange.end = null;
        }
        updateDashboard();
    });
    
    document.getElementById('open-modal-btn').addEventListener('click', () => { 
        clientIdInput.value = appConfig.googleClientId || ''; 
        workerUrlInput.value = appConfig.workerUrl || ''; 
        populateClientSettingsList(); 
        modal.classList.remove('hidden'); 
    });
    document.getElementById('close-modal-btn').addEventListener('click', () => modal.classList.add('hidden'));
    document.getElementById('save-settings-btn').addEventListener('click', saveConfig);
    document.getElementById('add-client-btn').addEventListener('click', addNewClient);
    document.getElementById('export-pdf-btn').addEventListener('click', exportToPdf);
    document.getElementById('generate-insights-btn').addEventListener('click', generateInsightsWithGemini);
    
    clientSelector.addEventListener('change', updateDashboard);
    
    const urlParams = new URLSearchParams(window.location.search);
    const tokenFromUrl = urlParams.get('token');

    if (tokenFromUrl) {
        sessionStorage.setItem('googleAuthToken', tokenFromUrl);
        // Remove the token from the URL for a cleaner look
        window.history.replaceState(null, null, window.location.pathname);
        googleAuthToken = tokenFromUrl; // Use token immediately after setting it
        updateUIonAuthSuccess();
        await loadRemoteConfig();
    } else {
        googleAuthToken = sessionStorage.getItem('googleAuthToken');
        if (googleAuthToken) {
            updateUIonAuthSuccess();
            await loadRemoteConfig();
        } else {
            updateUIonAuthFailure();
            renderMockData();
            showMessage("Benvenuto! Per iniziare, collega il tuo account Google.", "warning");
        }
    }
}

// --- FUNZIONI ESPORTA PDF E GEMINI ---
async function exportToPdf() {
    showMessage("Generazione del report PDF in corso...", "success");
    const { jsPDF } = window.jspdf;
    
    const dashboardElement = document.getElementById('pdf-export-area');
    
    // Force a print-specific scale if needed, but '2' is usually good for quality
    const canvas = await html2canvas(dashboardElement, { scale: 2, backgroundColor: '#111827' });
    
    const imgData = canvas.toDataURL('image/png');
    // Use the calculated canvas dimensions for the PDF to ensure 1:1 ratio
    const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: [canvas.width, canvas.height] });

    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
    
    const clientName = appConfig.clients[clientSelector.value]?.name || 'Cliente';
    const dateString = dateRange.start.format('YYYY-MM-DD');
    pdf.save(`Report_${clientName}_${dateString}.pdf`);
}

async function generateInsightsWithGemini() {
    const geminiBtn = document.getElementById('generate-insights-btn');
    const btnText = document.getElementById('gemini-btn-text');
    const loader = document.getElementById('gemini-loader');
    const textarea = document.getElementById('insights-textarea');

    if (!currentData.primary || !appConfig.workerUrl || !googleAuthToken) { 
        showMessage("Nessun dato da analizzare o Worker non configurato/autenticato.", "error"); 
        return; 
    }

    btnText.textContent = "Analizzo...";
    loader.classList.remove('hidden');
    geminiBtn.disabled = true;

    // Costruisci il summary dei dati per Gemini
    let dataSummary = `Analisi per ${appConfig.clients[clientSelector.value]?.name} nel periodo ${dateRange.start.format('DD/MM/YYYY')} - ${dateRange.end.format('DD/MM/YYYY')}.\n\n`;
    
    const p = currentData.primary;
    const c = currentData.comparison;

    dataSummary += "### RIASSUNTO KPI GLOBALI\n";
    dataSummary += `- Spesa Totale: ${formatCurrency(p.cost)}\n`;
    dataSummary += `- Costo Google Ads: ${formatCurrency(p.gadsCost)}\n`;
    dataSummary += `- Spesa Meta Ads: ${formatCurrency(p.metaSpend)}\n`;
    dataSummary += `- Click Totali: ${formatNumber((p.gads?.totals?.clicks || 0) + (p.meta?.totals?.clicks || 0))}\n`;
    dataSummary += `- Utenti Attivi (GA4): ${formatNumber(p.ga4?.totals?.activeUsers || 0)}\n`;
    dataSummary += `- Conversioni Totali: ${formatNumber((p.ga4?.totals?.conversions || 0) + (p.gads?.totals?.conversions || 0) + (p.meta?.totals?.conversions || 0))}\n`;
    dataSummary += `- Durata Media Sessione (GA4): ${formatTime(p.ga4?.totals?.averageSessionDuration || 0)}\n`;
    
    if (c) {
        dataSummary += "\n### COMPARAZIONE (vs Periodo Precedente)\n";
        dataSummary += `- Spesa Totale: ${formatComparison(p.cost, c.cost, 'cost')}\n`;
        dataSummary += `- Costo Google Ads: ${formatComparison(p.gadsCost, c.gadsCost, 'gadsCost')}\n`;
        dataSummary += `- Spesa Meta Ads: ${formatComparison(p.metaSpend, c.metaSpend, 'metaSpend')}\n`;
        dataSummary += `- Conversioni: ${formatComparison((p.ga4?.totals?.conversions || 0) + (p.gads?.totals?.conversions || 0) + (p.meta?.totals?.conversions || 0), (c.ga4?.totals?.conversions || 0) + (c.gads?.totals?.conversions || 0) + (c.meta?.totals?.conversions || 0), 'conversions')}\n`;
        dataSummary += `- Durata Media Sessione: ${formatComparison(p.ga4?.totals?.averageSessionDuration || 0, c.ga4?.totals?.averageSessionDuration || 0, 'averageSessionDuration')}\n`;
    }
    
    if (p.gads?.campaigns?.length > 0) {
        dataSummary += "\n### DETTAGLIO GOOGLE ADS (Top 10 Campagne)\n";
        p.gads.campaigns.forEach(camp => {
            dataSummary += `- ${camp.name}: Costo ${formatCurrency(camp.cost)}, Conv. ${formatNumber(camp.conversions)}, CPA ${formatCurrency(camp.cpa)}, Q. Imp. ${formatPercentage(camp.searchImpressionShare)}\n`;
        });
    }
    if (p.meta?.campaigns?.length > 0) {
        dataSummary += "\n### DETTAGLIO META ADS (Top Campagne)\n";
        p.meta.campaigns.forEach(camp => {
            dataSummary += `- ${camp.name}: Spesa ${formatCurrency(camp.spend)}, Conv. ${formatNumber(camp.conversions)}, CPA ${formatCurrency(camp.cpa)}, CTR ${formatPercentage(camp.ctr)}\n`;
        });
    }
    
    if (p.ga4?.traffic?.length > 0) {
        dataSummary += "\n### DETTAGLIO TRAFFICO GA4 (Top Sorgenti)\n";
        p.ga4.traffic.forEach(traffic => {
            dataSummary += `- ${traffic.source}: Utenti ${formatNumber(traffic.users)}, Sessioni ${formatNumber(traffic.sessions)}, Conv. ${formatNumber(traffic.conversions)}\n`;
        });
    }

    const systemPrompt = `Sei un esperto di marketing digitale senior dell'agenzia Beamlight. Analizza i dati forniti e scrivi un report professionale per il cliente. Utilizza un tono formale e professionale (es. "Si è osservato", "Si consiglia"). Struttura il report in Markdown con i seguenti titoli: 
# [Nome Cliente] - Analisi di Performance 
## 1. Panoramica Esecutiva (Max 3 frasi) 
## 2. Punti di Forza e Risultati Positivi (Utilizza bullet point, cita i dati) 
## 3. Aree di Miglioramento e Focus (Utilizza bullet point, cita i dati) 
## 4. Prossimi Passi e Raccomandazioni (Utilizza bullet point per le azioni concrete).`;

    try {
        // API call function with exponential backoff (simplified for clarity here, relying on fetch retry internally if possible)
        const response = await fetch(`${appConfig.workerUrl}/generate-insights`, {
            method: 'POST',
            headers: { 
                'Authorization': `Bearer ${googleAuthToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ dataSummary, systemPrompt })
        });
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `Il worker ha restituito un errore ${response.status}`);
        }
        const result = await response.json();
        const generatedText = result.text;
        if (generatedText) textarea.value = generatedText;
        else throw new Error("La risposta del worker era vuota.");
    } catch (error) {
        showMessage(`Errore generazione analisi: ${error.message}`, "error");
        textarea.value = "Impossibile generare l'analisi a causa di un errore. Controlla la console per i dettagli.";
        console.error("Errore Gemini Insights:", error);
    } finally {
        btnText.textContent = "Genera con Gemini";
        loader.classList.add('hidden');
        geminiBtn.disabled = false;
    }
}

initialize();
</script>
    </body>
</html>
